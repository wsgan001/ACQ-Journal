package EXP;

import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.FileReader;
import java.util.*;

import algorithm.CPTreeReader;
import algorithm.DataReader;
import algorithm.ProfiledTree.PNode;
import algorithm.kwIndex.KWTree;
import algorithm.kwIndex.Query1_margin.Query1;
import config.Config;

public class accuracy {
	int[][] graph = null;
	int[][] nodes = null;
	
	public accuracy(String graphFile, String nodeFile){
		DataReader dataReader = new DataReader(graphFile, nodeFile);
		graph = dataReader.readGraph();
		nodes = dataReader.readNodes();
	}

	public double precision(Set<Integer> QueryCommunity, Set<Integer> TrueCommunity){
		Set<Integer> set = new HashSet<Integer>();
		set.addAll(QueryCommunity);
		set.retainAll(TrueCommunity);
		double size1 = set.size();
		double size2 = QueryCommunity.size();
		return size1/size2;
	}
	
	public double recall(Set<Integer> QueryCommunity, Set<Integer> TrueCommunity){
		Set<Integer> set = new HashSet<Integer>();
		set.addAll(QueryCommunity);
		set.retainAll(TrueCommunity);
		double size1 = set.size();
		double size2 = TrueCommunity.size();
		return size1/size2;
	}
	

	public double F1(double precision, double recall){
		return 2*(precision*recall)/(precision+recall);
	}
	
	
	public Map<Integer, Set<Integer>> getGroundTrueCommunity(String file,int k){
		Map<Integer, Set<Integer>> queryIdCommunity = new HashMap<Integer, Set<Integer>>();
		try {
			BufferedReader reader = new BufferedReader(new FileReader(file));
			String line = new String();
			while((line=reader.readLine())!=null){
				String[] str = line.split("\t");
				if(str.length >= k+1){
					Random random = new Random();
					int queryId = Integer.parseInt(str[random.nextInt(str.length-2) + 1]);
					
					if(!queryIdCommunity.containsKey(queryId)){
						Set<Integer> commmunity = new HashSet<Integer>();
						for(int i = 1; i <str.length; i++ ){
							int vertex = Integer.parseInt(str[i]);
							commmunity.add(vertex);
						}
						queryIdCommunity.put(queryId, commmunity);
					} 	
				}
			}
			
		} catch (Exception e) {
			// TODO: handle exception
		}
		return queryIdCommunity;
	}
	
	
	private KWTree buildKWtree(String graphFile,String nodeFile,String CPtreeFile){
		CPTreeReader cpReader = new CPTreeReader(CPtreeFile);
		PNode root=cpReader.loadCPtreeRoot();
		KWTree kwTree = new KWTree(graphFile, nodeFile, root);
		kwTree.build();
		return kwTree;
	}
	
	
	public void test(int k,KWTree kwTree){
		Config.k = k;
		Query1 query1 = new Query1(graph, kwTree.getHeadList());
		query1.query(192, 3);
		 Map<Set<Integer>,Set<Integer>> patternUsers = query1.getPatternUsers();
		Iterator<Set<Integer>> communities = patternUsers.values().iterator();
		while(communities.hasNext()){
			System.out.println("Size: "+communities.next().size());
		}
	}
	
	
	
	
	
	public static void main(String[] args){
		String graphFile= "/Users/chenyankai/Documents/HKU_research/PCS/dataset/facebook/edges.txt";
		String nodesFile = "/Users/chenyankai/Documents/HKU_research/PCS/dataset/facebook/node.txt";
		String CPTreeFile = "/Users/chenyankai/Documents/HKU_research/PCS/dataset/facebook/CPTree.txt";
		
		accuracy accuracy = new accuracy(graphFile, nodesFile);
//		String file = "/Users/chenyankai/Downloads/facebook/0.circles";
//		Map<Integer, Set<Integer>> map = accuracy.getGroundTrueCommunity(file, 4);
//		for(Iterator<Integer> key = map.keySet().iterator(); key.hasNext();){
//			int queryId = key.next();
//			Set<Integer> community = map.get(queryId);
//			System.out.println("queryId: "+queryId+"  community :"+community.toString());
//		}
		
		KWTree kwTree = accuracy.buildKWtree(graphFile, nodesFile, CPTreeFile);
		accuracy.test(4, kwTree);
	}
	
}
